name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =========================
  # Backend Tests & Analysis
  # =========================
  backend:
    runs-on: ubuntu-latest
    name: Backend Tests (PHP 8.5)

    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.5']

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, fileinfo
        coverage: xdebug
        ini-values: error_reporting=E_ALL

    - name: Validate composer.json
      run: composer validate --strict

    - name: Cache Composer Dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php${{ matrix.php-version }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php${{ matrix.php-version }}-composer-

    - name: Install Composer Dependencies
      run: composer install --prefer-dist --no-interaction --no-progress --optimize-autoloader

    - name: Copy Environment File
      run: cp .env.example .env

    - name: Generate Application Key
      run: php artisan key:generate

    - name: Create SQLite Database
      run: |
        mkdir -p database
        touch database/database.sqlite

    - name: Run Database Migrations
      run: php artisan migrate --force

    - name: Run PHPStan Static Analysis
      run: |
        if [ -f "./vendor/bin/phpstan" ]; then
          ./vendor/bin/phpstan analyse --memory-limit=2G || echo "PHPStan not configured, skipping..."
        else
          echo "PHPStan not installed, skipping static analysis"
        fi

    - name: Execute Tests with Coverage (PEST)
      run: php artisan test --parallel --coverage --min=60

    - name: Upload Test Coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-php${{ matrix.php-version }}
        path: coverage/
        retention-days: 7
        if-no-files-found: ignore

    - name: Check for Security Vulnerabilities
      run: composer audit || echo "No vulnerabilities found"

  # =========================
  # Frontend Build & Tests
  # =========================
  frontend:
    runs-on: ubuntu-latest
    name: Frontend Build & Assets

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Cache Node Modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install NPM Dependencies
      run: npm ci

    - name: Run NPM Security Audit
      run: npm audit --audit-level=moderate || echo "Vulnerabilities found but continuing..."

    - name: Build Frontend Assets
      run: npm run build

    - name: Verify Build Output
      run: |
        if [ ! -f "public/build/manifest.json" ]; then
          echo "Build manifest not found!"
          exit 1
        fi
        echo "✅ Build successful"

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: public/build/
        retention-days: 7

  # =========================
  # Database & Seeding Test
  # =========================
  database:
    runs-on: ubuntu-latest
    name: Database Integrity

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.5'
        extensions: pdo, sqlite, pdo_sqlite
        coverage: none

    - name: Cache Composer
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

    - name: Install Dependencies
      run: composer install --prefer-dist --no-interaction

    - name: Setup Environment
      run: |
        cp .env.example .env
        php artisan key:generate
        touch database/database.sqlite

    - name: Test Fresh Migration
      run: php artisan migrate:fresh --force

    - name: Test Seeding
      run: php artisan db:seed --force || echo "No seeders configured"

    - name: Verify Database Schema
      run: |
        php artisan migrate:status
        echo "✅ Database schema verified"

  # =========================
  # Final Status & Notifications
  # =========================
  notify:
    runs-on: ubuntu-latest
    name: Notify Results
    needs: [backend, frontend, database]
    if: always()

    steps:
    - name: Determine Status
      id: status
      run: |
        if [ "${{ needs.backend.result }}" == "success" ] && [ "${{ needs.frontend.result }}" == "success" ] && [ "${{ needs.database.result }}" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "color=5763719" >> $GITHUB_OUTPUT
          echo "emoji=✅" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "color=15548997" >> $GITHUB_OUTPUT
          echo "emoji=❌" >> $GITHUB_OUTPUT
        fi

    - name: Send Discord Notification
      if: env.DISCORD_WEBHOOK != ''
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -n 1)
        AUTHOR="${{ github.event.head_commit.author.name }}"

        curl -H "Content-Type: application/json" -X POST -d "{
          \"embeds\": [{
            \"title\": \"CI Pipeline ${{ steps.status.outputs.emoji }}\",
            \"description\": \"**Branch:** \`${{ github.ref_name }}\`\n**Status:** ${{ steps.status.outputs.status }}\n**Commit:** ${COMMIT_MSG}\n**Author:** ${AUTHOR}\",
            \"color\": ${{ steps.status.outputs.color }},
            \"fields\": [
              {\"name\": \"Backend\", \"value\": \"${{ needs.backend.result }}\", \"inline\": true},
              {\"name\": \"Frontend\", \"value\": \"${{ needs.frontend.result }}\", \"inline\": true},
              {\"name\": \"Database\", \"value\": \"${{ needs.database.result }}\", \"inline\": true}
            ],
            \"footer\": {\"text\": \"AlSarya TV • ${{ github.workflow }}\"},
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
          }]
        }" $DISCORD_WEBHOOK || echo "Discord notification failed"
